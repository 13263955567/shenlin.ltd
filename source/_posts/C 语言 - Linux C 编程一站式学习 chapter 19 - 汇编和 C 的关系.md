---
title: C 语言 - Linux C 编程一站式学习 chapter 19 - 汇编和 C 的关系
categories: 
    - C 语言
    - Linux C 编程一站式学习
tags: C 语言
---

<!--more-->

## 函数调用

## main 函数和启动例程

## 变量的存储布局

## 结构体和联合体

## C 内联汇编

使用汇编的情形：

* C 程序要经由编译器生成汇编代码，现代编译器的优化不如手写代码
* C 语言的语法和概念是对各种平台的抽象，而各种平台特有的一些东西在C语言中没有等价的语法，所以有些平台相关的指令必须手写
    * 例如x86是端口I/O， 而C语言就没有这个概念，所以 in/out 指令必须用汇编来写

使用内联汇编的原因：

    根据应用场景为了兼得 C 语言和汇编的优点 ：C语言简洁易读，容易组织规模较大的代码，而汇编效率高，而且写一些特殊指令必须用汇编

内联汇编（Inline Assembly）

    gcc 提供了一种扩展语法可以在C代码中使用汇编语言

内联汇编举例

```c
__asm__("nop");                                                 // 单条汇编指令

__asm__("movl $1, %eax\n\t"                                     // 多条汇编指令使用 \n\t 分隔
        "movl $4, %ebx\n\t"
        "int $0x80");

// 内联汇编和 C 语言变量关联
// 可选的部分没有则空着只写个冒号
__asm__(assembler template                                      // 汇编指令
        : output operands                                       // 约束条件，可选，指示汇编指令的运算结果输出到哪些儿 C 操作数
        : input operands                                        // 约束条件，可选，指示汇编指令从哪些儿 C 操作数获得输入
        : list of clobbered registers                           // 可选，列出在汇编指令中被修改过的寄存器列表，
                                                                // 这样编译器就不会在执行这行代码时使用这些儿寄存器来保存其他值
        );
```

内联汇编完整举例
```c
/**
 * 将变量 a 的值赋给 b
 */
#include <stdio.h>
int main()
{
    int a = 10, b;

    __asm__("movl %1, %%eax\n\t"                                // %1 是占位符，对应 a，为了和占位符区分，寄存器 eax 前加了两个 %
            "movl %%eax, %0\n\t"                                // %0 是站位符，对应 b
            :"=r"(b)                                            // 把 %0 代表的寄存器的值输出给变量 b
            :"r"(a)                                             // 指示编译器分配一个寄存器保存变量 a  的值
            :"%eax"                                             // 告诉编译器寄存器 eax 的值被改变了，所以在执行 __asm__ 时不要用 eax 再保存其他值
    );
    printf("Result: %d, %d\n", a, b);

    return 0;
}
```

## volatile 限定符

